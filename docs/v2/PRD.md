# 男频网文 AI 作者工具（Web）PRD v2.0

## 1. 迭代背景与目标
在 V1.0 版本的开发中，我们已成功构建了从项目管理、设定库 (Lorebook)、大纲引擎到 AI 章节续写/重写及核心一致性检查的基础底座。但在对齐初始设计时，我们发现存在部分功能缺失与用户体验断层的问题。

**V2.0 迭代的核心目标**：
1. **填补 V1 遗漏闭环**：补齐规划中的特性，如强制圣经流程、Word 导出、更多维度的写作干预参数及章节锁定等。
2. **落实用户最新反馈 (Bugfix & 体验升级)**：合并最新要求的交互优化，消除痛点，让工作流更顺畅自然。

---

## 2. V1 遗漏需求补齐 (Gaps Remediation)

### 2.1 基础设定 => 作品圣经 向导式引导
- **现状**：目前用户创建作品后，没有统一收集主角、金手指、升级体系的表单，设定需要一项项手动添加到设定库中。
- **新需求**：在前端项目 Dashboard 增加 **“生成作品圣经”** 的强制/推荐引导流，收集核心要素并一次性通过 AI 批量生成多种类型（角色、世界观、功法）的 Lore items，落库至设定库中。

### 2.2 大纲锁定机制与 30 章基准
- **现状**：生成大纲没有数量概念且不能锁定，容易被覆盖。
- **新需求**：
  1. 大纲生成 Prompt 中强化“生成前 30 章逻辑”等量化指标提示。
  2. 支持在 UI 对具体的章节/卷点击“锁定 (Lock)”，被锁定的章节在后续发生 AI 重写或生成刷新时将被原样保留。
  3. **章节任务卡 (Chapter Task Card)**：编辑器侧边栏必须显式加载并常驻当前章节对应的“大纲卡片（包含：本章目标、预期冲突、反转、章尾钩子）”，作为作者和 AI 共写的**核心参照物**。

### 2.3 章节共写参数扩展
- **现状**：存在续写 (Continue) 与基础重写 (Rewrite)。
- **新需求**：在写作辅助面板上扩充控制参数：**节奏（慢/中/快）、爽感等级、扩写/压缩模式约束**，将其纳入传递给后端的 Prompt。

### 2.4 版本管理 (快照) 逻辑调整
- **现状**：拥有全套底层 Snapshot 系列接口，但目前主要依赖手动打快照，且没有端到端的段落 Diff 对比工具。
- **新需求 (来自 PRD-1.md 的确认)**：
  1. 取消独立的“手动快照”入口按钮。
  2. **与“保存操作”挂钩**：拦截编辑器的自动/手动保存请求（当内容实质改变时），在后端或前端触发 `/snapshots`，实现“隐式版本快照”。
  3. 支持简单的版本回波及切换查看（无需极高密度的行内 Diff，但需要保留还原入口）。

### 2.5 沉浸式一致性检查 (Consistency Guard)
- **现状**：一致性检查是一个独立剥离的操作过程。
- **新需求**：
  1. **伴随式触发**：在完成一定字数的写作后（或在用户手动点击保存/发布草稿时），在后台静默触发 `/api/chapters/{chapter_id}/consistency-check`。
  2. **UI 侧边栏/底部抽屉展示**：分析出的人设、战力、时间线约束问题应直接以“建议卡片”或“波浪线高亮”形式显示在编辑器辅助区域，并提供“一键应用修复 (Apply Fix)” 操作直接替换出问题段落。

### 2.5 导出格式扩展
- **现状**：支持 `.txt` 导出。
- **新需求**：增加并实现 `.docx` 的标准 Word 文档格式汇聚导出。

---

## 3. Bug 修复与体验优化 (来自 V2 用户反馈)

### 3.1 润色重写交互优化
- **需求 / Bug**：
  1. 当呼出选中文本的“润色重写”弹窗时，背后的编辑器光标选中高亮会消失。要求弹窗展示期间保持编辑器内对应文本的选中状态。
  2. 在重写气泡/弹窗中，允许用户通过输入框提交“自定义修改指令 (Custom Instructions)”。

### 3.2 大纲覆盖第一卷标题丢失问题
- **Bug 描述**：使用“AI 一键生成”的大纲并执行“应用到项目”时，第一卷的首个标题在某些转化下出现丢失或显示为空。
- **修复预期**：检查并修复 Json 转化和应用算法，保证所见即所得。

### 3.3 一致性检查无视中文指令问题
- **Bug 描述**：虽然系统设定已转中文，但一致性检查工具的回调在深层推理中有时会输出全英文。
- **修复预期**：在 `consistency.py` 关联的相关 Prompt 里加入更为严苛的**纯中文 JSON 输出**强制规则，修正界面渲染时的语言鸿沟。

---

## 4. 验收标准
1. 在“保存”功能中必定能沉淀出一个快照记录，原“创建快照”等独立操作退出历史节点。
2. 使用修改指令进行重写时，输入指令能切实影响输出，并且编辑器底本持续高亮。
3. 从大纲应用到界面的全层级标题（卷名、章名）数据丝毫不丢。
4. “一致性校验”和所提供建议 100% 均为中文描述。
5. 能够正确拼装并导出带目录结构的 Docx 文档。
