# 男频网文 AI 作者工具 V2 迭代计划 (Agile Release Plan)

基于 V2.0 PRD 与技术重构方案，并且根据开发团队的最新要求将**“生成作品圣经”与初创引导流程提至最高优先级**，我们将本次 V2 版本的核心需求重组，拆解为以下 **3 个核心 Sprint**。每个 Sprint 周期建议为 **1~2 周**。

---

## 🚩 Sprint 1: 创世向导与长程推演 (Project Init & Outline)
**目标**：优先攻克项目的“从 0 到 1”新手启动阶段。通过向导式的一键设定抓取作品灵魂，并基于滑动窗口技术推演可靠的长程大纲，确保作家不要迷失在起步阶段。

**核心 User Stories & 任务拆解**：
- [ ] **Task 1.1 前端**: 新增“一键创世/生成圣经”的向导 (Wizard) 强制/推荐拦截页，收集核心系统流要素。
- [ ] **Task 1.2 后端**: 新增 `POST /api/projects/{id}/generate-bible` 异步生成引擎接口与 `tags_json` 标记落盘逻辑。
- [ ] **Task 1.3 进度推送**: 补充 `GET /api/projects/{id}/generate-bible/status` (SSE 流式通道)，实现前端实时跳动的要素掉落加载动画。
- [ ] **Task 1.4 大纲引擎重构**: 引入核心**滑动窗口模式 (Sliding Window)**，不再要求模型一口气输出，而是单次一卷滚动接力，防止 Token 被击穿。
- [ ] **Task 1.5 纯中文防线**: 测试并在全 Prompt 收口处增加完整繁简中文字符集的强约束，彻底修复第一卷标题丢失及中英混杂 Bug。

**交付标准**：新项目的冷启动丝滑无比。用户填完简短的设定，立马能看到满屏的世界观设定自动生成，并无Bug顺畅推演前 30 章扎实可行的大纲框架。

---

## 🚩 Sprint 2: 沉浸式写作基建与防脏写保护 (Writing Experience)
**目标**：有了前期的世界设定和大纲底座后，第二阶段聚焦改进写文界面的交互痛点。让大纲不再仅仅是个摆设，而是紧扣每一段文字的“灵魂指导书”。

**核心 User Stories & 任务拆解**：
- [ ] **Task 2.1 数据库结构**: 增加大纲的 `locked` 字段及 Snapshot 的分类枚举分类 (`auto`/`manual`)。
- [ ] **Task 2.2 防并发锁**: 改造 `PATCH /api/projects/{id}/outline/lock`，引入基于系统 `version` 校验的乐观锁防脏机制，发生并发覆盖时抛出 409 冲刷报错。
- [ ] **Task 2.3 章节任务卡**: 开发 UI 组件，强行固定大纲摘要（目前章节的冲突/目标/钩子）在编辑侧边栏，并伴随内容 `POST` 作为注入关联的 `Task_Context` 给大语言模型。
- [ ] **Task 2.4 共写引擎升级**: 扩充 `instruction` 自定义指令通道及“节奏、爽感、模式”的三向参数下发。
- [ ] **Task 2.5 选区保护**: 捕获并持久化富文本选区状态，确保任何气泡弹窗唤起时，底层编辑器文字高亮不丢失。

**交付标准**：作者在写作界面随时看得到章节任务卡。大纲内容不再被自动覆盖，且多维度的重写扩写体验得心应手。

---

## 🚩 Sprint 3: 自动化钩子与全局导出闭环 (Hooks & Export)
**目标**：隐藏冰冷的极客技术按钮，用完全无感的自动化与伴随式交互解放创作者心智，最后搞定网文作者必不可少的导出投稿能力。

**核心 User Stories & 任务拆解**：
- [ ] **Task 3.1 静默快照钩子**: 取消页面手动存量按钮。在 `PUT /api/chapters/{id}` 动作内拦截并加入字数剧变阈值差与时间防抖运算，通过策略自动归档快照。
- [ ] **Task 3.2 伴随式一致性巡检**: 将独立检查按钮解耦。绑在后台保存请求成功后的异步链路上，按需静默触发 `/consistency-check`。
- [ ] **Task 3.3 沉浸式检出错**: 前端解析回调出来的 `consistency_issues` 给编辑器内的人设、逻辑错文画“波浪线”，构建沉浸式批注点选替换功能。
- [ ] **Task 3.4 Docx 引擎**: 引入 `python-docx` 生态，搭建完备的前后章层级与章节标题导出合并架构。
- [ ] **Task 3.5 N+1 查询爆破**: 为了导出性能，必须将服务端树状查循环遍历替换为 SQLAlchemy 的 `joinedload` 提前加载，并封装 StreamingResponse 进行无塞流下发。

**交付标准**：系统具备极高容错与快照护城河，化身副手帮你画波浪线捉虫。成稿后即使百章千章也能秒出格式精美的完整 Word。

---

## 📈 后续 Milestone (Sprint 4+) 展望
- 团队空间 (Team Collaboration) 与跨用户细粒度共同协作权限控制引入。
- 运营端/商业侧的 Token 计费池机制的完整后台监控看板对接。
- 扩充玄幻外（如言情、无限流、剧本杀、跑团规则）的跨库知识源体系引擎与对应的 UI。
